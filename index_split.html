<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ohio Charity Directory</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body{font-family:system-ui,Arial;max-width:1200px;margin:18px auto;padding:0 14px;color:#000;background:#fff}
    h1{font-size:20px;margin:0 0 6px;text-align:center}
    .muted{color:#555;font-size:13px;margin:6px 0 12px;text-align:center}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0}
    .btn{display:inline-block;padding:8px 12px;border:1px solid #000;border-radius:8px;text-decoration:none;color:#000;background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .chip{padding:6px 10px;border:1px solid #000;border-radius:999px;font-size:12px}
    .card{border:1px solid #000;border-radius:10px;padding:12px;margin:10px 0}
    .name{font-weight:700;font-size:16px}
    .meta{font-size:12px;color:#555;margin-top:4px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    input{padding:8px 10px;border:1px solid #ccc;border-radius:8px;min-width:240px}
    select{padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:#fff}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .badge{border:1px solid #000;border-radius:999px;padding:4px 8px;font-size:12px}
    .badge.soft{border-color:#555;color:#555}
    .badge.note{font-style:italic}

    /* Layout */
    #layout{display:block;margin-top:10px}
    #list{margin-top:0}
    #mapWrap{display:none;margin-top:0}
    #map{height:360px;border:1px solid #000;border-radius:10px}
    #mapStatus{margin-top:6px}

    /* Desktop/tablet split view */
    @media (min-width: 900px){
      #layout{
        display:grid;
        grid-template-columns: 380px 1fr;
        gap: 14px;
        align-items:start;
      }
      #listPanel{
        max-height: calc(100vh - 210px);
        overflow:auto;
        padding-right:4px;
      }
      #mapWrap{display:block}
      #map{
        height: calc(100vh - 250px);
        min-height: 520px;
      }
      #toggleMapBtn{display:none}
    }
  </style>
</head>
<body>
  <h1>Ohio Charity Directory</h1>
  <div class="muted" id="subtitle">Showing vetted charities.</div>

  <!-- Search + primary actions -->
  <div class="bar">
    <input id="search" placeholder="Search (name, city)â€¦" />
    <button class="btn" id="applyBtn">Apply</button>
    <button class="btn" id="toggleMapBtn">Show on map</button>
    <span class="chip" id="activeFilters"></span>
  </div>

  <!-- User-adjustable filters -->
  <div class="bar" id="filterBar">
    <select id="causeSelect">
      <option value="">All causes</option>
      <option value="animals">Animals</option>
    </select>

    <select id="citySelect">
      <option value="">All cities</option>
    </select>

    <label class="chip" style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="applePayOnly">
      Apple Pay only
    </label>

    <button class="btn" id="clearFiltersBtn">Clear filters</button>
  </div>

  <div id="layout">
    <div id="listPanel">
      <div id="list"></div>
    </div>

    <div id="mapPanel">
      <div id="mapWrap">
        <div id="map"></div>
        <div class="muted" id="mapStatus">Loading mapâ€¦</div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.4';

  // âœ… Your Supabase project details (already filled from your last file)
  const SUPABASE_URL = 'https://fqlqqgjblnksfluzhnpf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxbHFxZ2pibG5rc2ZsdXpobnBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTQzMjEsImV4cCI6MjA3MDQzMDMyMX0.EKBrkuxyNWGWmSL8f9nVFKrjR5XNMrYyfwJmaGrM8IE';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $list = document.getElementById('list');
  const $filters = document.getElementById('activeFilters');
  const $mapWrap = document.getElementById('mapWrap');
  const $toggleMapBtn = document.getElementById('toggleMapBtn');
  const $mapStatus = document.getElementById('mapStatus');

  function escapeHtml(s='') {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function normalizeCity(s='') { return String(s).trim(); }
  function isDesktopSplit() { return window.matchMedia('(min-width: 900px)').matches; }
  function isMapVisible() { return isDesktopSplit() || ($mapWrap.style.display === 'block'); }

  // ---------- Filters (UI only) ----------
  function getFiltersFromUI() {
    const cause = document.getElementById('causeSelect').value || '';
    const city = document.getElementById('citySelect').value || '';
    const wallet = document.getElementById('applePayOnly').checked ? 'applepay' : '';
    const q = document.getElementById('search').value.trim() || '';
    return { cause, city, wallet, q };
  }

  function setFilterBadge(f) {
    const bits = [];
    if (f.cause) bits.push(`cause=${f.cause}`);
    if (f.city) bits.push(`city=${f.city}`);
    if (f.wallet) bits.push(`wallet=${f.wallet}`);
    if (f.q) bits.push(`q=${f.q}`);
    $filters.textContent = bits.length ? `Filters: ${bits.join(' â€¢ ')}` : 'No filters';
  }

  // ---------- Rendering ----------
  function charityCard(c) {
    const city = c.city ? `${c.city}, ${c.state || 'OH'}` : '';
    const tags = Array.isArray(c.cause_tags) ? c.cause_tags.join(', ') : '';
    const donateLabel = 'Donate on official site';

    const badges = [];
    if (c.apple_pay_supported) badges.push(`<span class="badge">Supports Apple Pay</span>`);
    badges.push(`<span class="badge">Supports Credit/Debit</span>`);
    badges.push(`<span class="badge soft note">Direct Donate: coming soon</span>`);

    return `
      <div class="card">
        <div class="name">${escapeHtml(c.name)}</div>
        <div class="meta">${escapeHtml(city)}${city && tags ? ' â€¢ ' : ''}${escapeHtml(tags)}</div>
        ${badges.length ? `<div class="badges">${badges.join('')}</div>` : ''}
        <div class="row">
          <a class="btn" href="${escapeHtml(c.donate_url)}" target="_blank" rel="noopener">ðŸ’š ${donateLabel}</a>
          ${c.website_url ? `<a class="btn" href="${escapeHtml(c.website_url)}" target="_blank" rel="noopener">Website</a>` : ''}
        </div>
      </div>
    `;
  }

  // ---------- Data loading ----------
  async function loadCitiesForDropdown() {
    const { data, error } = await supabase
      .from('charities')
      .select('city')
      .eq('vetted_status', 'vetted')
      .eq('is_ohio_based', true);

    if (error) return;

    const cities = Array.from(new Set((data || [])
      .map(r => normalizeCity(r.city || ''))
      .filter(Boolean)))
      .sort((a,b) => a.localeCompare(b));

    const citySelect = document.getElementById('citySelect');
    citySelect.innerHTML = '<option value="">All cities</option>';
    for (const city of cities) {
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      citySelect.appendChild(opt);
    }
  }

  async function loadCharities() {
    const f = getFiltersFromUI();
    setFilterBadge(f);

    let q = supabase
      .from('charities')
      .select('id,slug,name,website_url,donate_url,venmo_handle,apple_pay_supported,address1,address2,city,state,zip,cause_tags,lat,lng,vetted_status,is_ohio_based')
      .eq('vetted_status', 'vetted')
      .eq('is_ohio_based', true);

    if (f.cause) q = q.contains('cause_tags', [f.cause.toLowerCase()]);
    if (f.city) q = q.ilike('city', `%${f.city}%`);
    if (f.wallet === 'applepay') q = q.eq('apple_pay_supported', true);

    const { data, error } = await q.order('name', { ascending: true });
    if (error) {
      $list.innerHTML = `<div class="card">Supabase error: ${escapeHtml(error.message)}</div>`;
      return [];
    }

    let results = data || [];

    const queryText = (f.q || '').trim().toLowerCase();
    if (queryText) {
      results = results.filter(x =>
        (x.name || '').toLowerCase().includes(queryText) ||
        (x.city || '').toLowerCase().includes(queryText)
      );
    }

    $list.innerHTML = results.length
      ? results.map(charityCard).join('')
      : `<div class="card">No charities match these filters.</div>`;

    return results;
  }

  // ---------- Browser geocoding (Nominatim) ----------
  const GEO_CACHE_KEY = 'geo_cache_v1';
  function loadGeoCache() { try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); } catch { return {}; } }
  function saveGeoCache(cache) { try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch {} }

  function addrKey(c) {
    return [c.address1, c.address2, c.city, c.state, c.zip].filter(Boolean).join('|').toLowerCase();
  }
  function buildAddressQuery(c) {
    return [c.address1, c.address2, c.city, c.state || 'OH', c.zip].filter(Boolean).join(', ');
  }
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function geocodeNominatim(address) {
    const q = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) return null;
    const data = await res.json();
    if (!data?.length) return null;
    return { lat: Number(data[0].lat), lng: Number(data[0].lon) };
  }

  // ---------- Map ----------
  let map, markersLayer, L;

  async function ensureMap() {
    if (map) return;
    L = await import('https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js');
    map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    map.setView([39.9612, -82.9988], 7);
  }

  function formatAddress(c) {
    const line1 = [c.address1, c.address2].filter(Boolean).join(' ');
    const line2 = [c.city, c.state || 'OH', c.zip].filter(Boolean).join(', ');
    const full = [line1, line2].filter(Boolean).join('<br>');
    return full || '<span style="color:#555">Address not listed</span>';
  }

  function addMarker(c, lat, lng) {
    const popupHtml = `
      <div style="max-width:260px">
        <div style="font-weight:700;margin-bottom:6px">${escapeHtml(c.name)}</div>
        <div style="font-size:12px;color:#333;margin-bottom:10px">${formatAddress(c)}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="${escapeHtml(c.donate_url)}" target="_blank" rel="noopener">Donate</a>
          <button class="btn" disabled title="Direct Donate coming soon">Direct Donate</button>
        </div>
      </div>
    `;
    L.marker([lat, lng]).addTo(markersLayer).bindPopup(popupHtml);
  }

  async function plotCharitiesOnMap(charities) {
    await ensureMap();
    markersLayer.clearLayers();

    const geoCache = loadGeoCache();
    let plotted = 0;
    let geocoded = 0;

    $mapStatus.textContent = 'Plotting charitiesâ€¦';

    for (const c of charities) {
      if (c.lat && c.lng) {
        addMarker(c, Number(c.lat), Number(c.lng));
        plotted++;
      }
    }

    for (const c of charities) {
      if (c.lat && c.lng) continue;
      if (!c.address1) continue;

      const key = addrKey(c);
      if (geoCache[key]) {
        addMarker(c, geoCache[key].lat, geoCache[key].lng);
        plotted++;
        continue;
      }

      const address = buildAddressQuery(c);
      if (!address) continue;

      await sleep(1000);
      const geo = await geocodeNominatim(address);
      if (geo) {
        geoCache[key] = geo;
        saveGeoCache(geoCache);
        addMarker(c, geo.lat, geo.lng);
        plotted++;
        geocoded++;
      }
    }

    const points = [];
    markersLayer.eachLayer(layer => { if (layer.getLatLng) points.push(layer.getLatLng()); });

    if (points.length) {
      map.fitBounds(L.latLngBounds(points), { padding: [20, 20] });
      $mapStatus.textContent = `Map ready: plotted ${plotted} location(s) (${geocoded} geocoded this session).`;
    } else {
      $mapStatus.textContent = 'No locations to plot yet. Add address1/city/zip for each charity.';
    }

    try { map.invalidateSize(); } catch {}
  }

  // ---------- Orchestration ----------
  async function refreshAll() {
    const charities = await loadCharities();
    if (isMapVisible()) {
      $mapWrap.style.display = 'block';
      await plotCharitiesOnMap(charities);
    }
    return charities;
  }

  // ---------- Events ----------
  document.getElementById('causeSelect').addEventListener('change', refreshAll);
  document.getElementById('citySelect').addEventListener('change', refreshAll);
  document.getElementById('applePayOnly').addEventListener('change', refreshAll);
  document.getElementById('applyBtn').addEventListener('click', refreshAll);

  document.getElementById('clearFiltersBtn').addEventListener('click', () => {
    document.getElementById('search').value = '';
    document.getElementById('causeSelect').value = '';
    document.getElementById('citySelect').value = '';
    document.getElementById('applePayOnly').checked = false;
    refreshAll();
  });

  $toggleMapBtn.addEventListener('click', async () => {
    const isShown = $mapWrap.style.display === 'block';
    if (isShown) {
      $mapWrap.style.display = 'none';
      $toggleMapBtn.textContent = 'Show on map';
    } else {
      $mapWrap.style.display = 'block';
      $toggleMapBtn.textContent = 'Hide map';
      await refreshAll();
    }
  });

  // ---------- Boot ----------
  await loadCitiesForDropdown();
  await refreshAll();

  if (isDesktopSplit()) {
    $mapWrap.style.display = 'block';
    await refreshAll();
  }
</script>
</body>
</html>
